version: 2.1
executors:
  docker-executor:
    docker: 
      - image: docker:17.05.0-ce-git

orbs:
  ghostinspector: ghostinspector/test-runner@1.0.0

jobs:
  test_plugin:
    executor: docker-executor
    steps:
      - setup_remote_docker
      - checkout
      - run:
          name: Set up network
          command: |
            docker network create wp-network
      - run:
          name: Set up database
          command: |
            docker run -d \
              -e MYSQL_ROOT_PASSWORD=1234 \
              -e MYSQL_DATABASE=wordpress \
              --name db \
              --network wp-network \
              mysql:5.7
      - run:
          name: Start WordPress
          command: |
            docker run -d \
              -e WORDPRESS_DB_HOST=db:3306 \
              -e WORDPRESS_DB_USER=root \
              -e WORDPRESS_DB_PASSWORD=1234 \
              -e WORDPRESS_DB_NAME=wordpress \
              --name wp-container \
              --network wp-network \
              wordpress
      - run:
          name: Install WordPress
          command: |
            docker run -it --rm \
              --volumes-from wp-container \
              --network wp-network \
              wordpress:cli core install \
                --url=localhost \
                --title=test \
                --admin_user=admin \
                --admin_password=admin \
                --admin_email=foo@bar.com
      - run:
          name: Install Ghost Inpector plugin
          command: |
            docker run -it --rm \
              --volumes-from wp-container \
              --user xfs \
              --network wp-network \
              wordpress:cli plugin install ghost-inspector \
                --activate \
                --url=localhost
      - ghostinspector/test-standalone-app:
          suite-id: $GI_SUITE
          network: wp-network
          vpn-token: $NGROK_TOKEN
          vpn-target: 'wp-container:80'

workflows:
  test:
    jobs:
      - test_plugin